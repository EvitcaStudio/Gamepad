<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamepad Test Suite</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Test suite for the Gamepad API library">
    <meta name="theme-color" content="#0066cc">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Gamepad">
    <meta name="msapplication-TileColor" content="#0066cc">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icons/gamepad-icon.svg">
    <link rel="icon" type="image/svg+xml" href="/icons/gamepad-icon.svg">
    <link rel="shortcut icon" href="/icons/gamepad-icon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #fff;
            color: #333;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #000;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        h2 {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .status {
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            background: #f5f5f5;
            font-size: 0.95em;
        }

        .status.connected {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .status.disconnected {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .section {
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 15px;
        }

        .controller-info {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .controller-info p {
            margin: 4px 0;
        }

        .controller-info strong {
            color: #000;
        }

        .dead-zone-controls {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .dead-zone-control {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .dead-zone-control label {
            font-weight: 600;
            min-width: 120px;
        }

        .dead-zone-control input[type="range"] {
            flex: 1;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
        }

        .button {
            background: #f0f0f0;
            color: #666;
            border: 1px solid #ccc;
            padding: 12px 8px;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
            transition: all 0.15s ease;
            cursor: default;
        }

        .button.pressed {
            background: #0066cc;
            color: #fff;
            border-color: #0052a3;
        }

        .button-value {
            font-size: 0.75em;
            margin-top: 4px;
            font-family: 'Courier New', monospace;
            opacity: 0.8;
        }

        .analog-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .analog-section {
            text-align: center;
        }

        .analog-section h3 {
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .analog-stick {
            background: #f0f0f0;
            border: 2px solid #ccc;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            position: relative;
            margin: 10px auto;
        }

        .analog-indicator {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #0066cc;
            border: 2px solid #fff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.05s ease;
        }

        .analog-info {
            font-size: 0.85em;
            color: #666;
            font-family: 'Courier New', monospace;
        }

        .vibration-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .vibration-btn {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ccc;
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .vibration-btn:hover {
            background: #e8e8e8;
            border-color: #999;
        }

        .vibration-btn:active {
            background: #ddd;
        }

        .vibration-btn.stop {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        .vibration-btn.stop:hover {
            background: #ffcdd2;
        }

        .event-log {
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
        }

        .event-log .event {
            margin: 3px 0;
            padding: 4px;
            border-left: 2px solid #ddd;
            padding-left: 8px;
        }

        .event-log .event.buttondown {
            border-left-color: #4caf50;
            background: #f1f8f4;
        }

        .event-log .event.buttonup {
            border-left-color: #f44336;
            background: #fef5f5;
        }

        .event-log .event.axischange {
            border-left-color: #2196f3;
            background: #f3f8fd;
        }

        .event-log .event.grab {
            border-left-color: #ff9800;
            background: #fff8f3;
        }

        .event-log .event.drop {
            border-left-color: #9e9e9e;
            background: #f9f9f9;
        }

        .clear-log {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ccc;
            padding: 8px 12px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .clear-log:hover {
            background: #e8e8e8;
        }

        .controller-selector {
            margin-bottom: 15px;
        }

        .controller-selector select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            background: #fff;
            font-size: 0.9em;
        }

        .install-prompt {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffffff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 300px;
        }

        .install-content h3 {
            margin: 0 0 8px 0;
            font-size: 1.1em;
            color: #0066cc;
        }

        .install-content p {
            margin: 0 0 12px 0;
            font-size: 0.9em;
            color: #666;
        }

        .install-btn, .dismiss-btn {
            padding: 8px 16px;
            margin-right: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
        }

        .install-btn {
            background: #0066cc;
            color: white;
        }

        .install-btn:hover {
            background: #0052a3;
        }

        .dismiss-btn {
            background: #f5f5f5;
            color: #666;
        }

        .dismiss-btn:hover {
            background: #e8e8e8;
        }

        .pattern-designer {
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
        }

        .pattern-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .pattern-btn {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ccc;
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 4px;
        }

        .pattern-btn:hover {
            background: #e8e8e8;
            border-color: #999;
        }

        .pattern-btn.stop {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        .pattern-btn.stop:hover {
            background: #ffcdd2;
        }

        .pattern-list {
            min-height: 200px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            background: #fff;
        }

        .pattern-placeholder {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        .pattern-item {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            position: relative;
        }

        .pattern-item:hover {
            border-color: #0066cc;
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
        }


        .pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pattern-title {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .pattern-actions {
            display: flex;
            gap: 5px;
        }

        .pattern-action-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.8em;
            transition: background 0.15s ease;
        }

        .pattern-action-btn:hover {
            background: #f0f0f0;
        }

        .pattern-action-btn.remove {
            color: #f44336;
            font-size: 1.2em;
            font-weight: bold;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pattern-action-btn.remove:hover {
            background: #ffebee;
        }

        .pattern-properties {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .pattern-property {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pattern-property label {
            font-size: 0.8em;
            font-weight: 500;
            color: #666;
        }

        .pattern-property input {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .pattern-property input:focus {
            outline: none;
            border-color: #0066cc;
        }

        .code-output {
            margin-top: 20px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
                padding: 15px;
            }
            
        .code-output h3 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: #333;
        }

        .code-output pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            margin: 0 0 10px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }


        .theme-toggle {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0;
        }

        .theme-toggle:hover {
            background: #e9ecef;
            transform: scale(1.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
        }

        .theme-toggle.dark {
            background: #343a40;
            border-color: #495057;
            color: #f8f9fa;
        }

        .theme-toggle.dark:hover {
            background: #495057;
        }

        /* Dark theme styles */
        body.dark {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark .container {
            background: #2d2d2d;
            border-color: #404040;
        }

        body.dark .status {
            background: #404040;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark .status.connected {
            background: #1b5e20;
            border-color: #2e7d32;
        }

        body.dark .controller-info {
            background: #404040;
            border-color: #555;
        }

        body.dark .analog-container {
            background: #404040;
            border-color: #555;
        }

        body.dark .analog-display {
            background: #333;
            border-color: #555;
        }

        body.dark .analog-info {
            color: #999;
        }

        body.dark .button-grid {
            background: #404040;
            border-color: #555;
        }

        body.dark .button {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark .button:hover {
            background: #404040;
        }

        body.dark .button.pressed {
            background: #0066cc;
            border-color: #0080ff;
            color: white;
        }

        body.dark .vibration-controls {
            background: #404040;
            border-color: #555;
        }

        body.dark .vibration-btn {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark .vibration-btn:hover {
            background: #404040;
        }

        body.dark .vibration-btn.stop {
            background: #4a1a1a;
            border-color: #6d2424;
            color: #ff6b6b;
        }

        body.dark .vibration-btn.stop:hover {
            background: #5d2020;
        }

        body.dark .event-log {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark .pattern-designer {
            background: #404040;
            border-color: #555;
        }

        body.dark .pattern-controls {
            background: #333;
            border-color: #555;
        }

        body.dark .pattern-btn {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark .pattern-btn:hover {
            background: #404040;
        }

        body.dark .pattern-btn.stop {
            background: #4a1a1a;
            border-color: #6d2424;
            color: #ff6b6b;
        }

        body.dark .pattern-btn.stop:hover {
            background: #5d2020;
        }

        body.dark .pattern-item {
            background: #333;
            border-color: #555;
        }

        body.dark .pattern-item:hover {
            border-color: #0066cc;
        }

        body.dark .pattern-property input {
            background: #404040;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark .pattern-property input:focus {
            border-color: #0066cc;
        }

        body.dark .code-output {
            background: #333;
            border-color: #555;
        }

        body.dark .code-output pre {
            background: #1a1a1a;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark .install-prompt {
            background: #0066cc;
            border-color: #0080ff;
        }

        body.dark .install-prompt:hover {
            background: #0052a3;
        }

        body.dark .header h1 {
            color: #e0e0e0;
        }

        body.dark .analog-stick {
            background: #333;
            border-color: #555;
        }

        body.dark .analog-stick::before {
            background: #555;
        }

        body.dark .analog-stick.grabbed::before {
            background: #0066cc;
        }

        body.dark .pattern-list {
            background: #333;
            border-color: #555;
        }

        body.dark .pattern-placeholder {
            color: #999;
        }

        body.dark .pattern-property label {
            color: #e0e0e0;
        }

        body.dark select {
            background: #404040;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark select:focus {
            border-color: #0066cc;
        }

        body.dark select option {
            background: #404040;
            color: #e0e0e0;
        }

        body.dark .section {
            background: #404040;
            border-color: #555;
        }

        body.dark .section h2 {
            color: #e0e0e0;
        }

        body.dark .section h3 {
            color: #e0e0e0;
        }

        body.dark .controller-selector {
            background: #333;
            border-color: #555;
        }

        body.dark .controller-selector label {
            color: #e0e0e0;
        }

        body.dark .dead-zone-controls {
            background: #333;
            border-color: #555;
        }

        body.dark .dead-zone-control label {
            color: #e0e0e0;
        }

        body.dark .dead-zone-control input[type="range"] {
            background: #404040;
        }

        body.dark .dead-zone-control span {
            color: #e0e0e0;
        }

        body.dark .analog-section {
            background: #333;
            border-color: #555;
        }

        body.dark .analog-section h3 {
            color: #e0e0e0;
        }

        body.dark .analog-indicator {
            background: #0066cc;
        }

        body.dark .pattern-action-btn {
            background: #dc3545;
            border-color: #c82333;
            color: white;
        }

        body.dark .pattern-action-btn:hover {
            background: #c82333;
        }

        body.dark .clear-log {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark .clear-log:hover {
            background: #404040;
        }

        body.dark .install-content {
            background: #404040;
            border-color: #555;
        }

        body.dark .install-content h3 {
            color: #e0e0e0;
        }

        body.dark .install-content p {
            color: #e0e0e0;
        }

        body.dark .install-btn {
            background: #28a745;
            border-color: #1e7e34;
            color: white;
        }

        body.dark .install-btn:hover {
            background: #1e7e34;
        }

        body.dark .dismiss-btn {
            background: #6c757d;
            border-color: #545b62;
            color: white;
        }

        body.dark .dismiss-btn:hover {
            background: #545b62;
        }

        body.dark .event-log .event {
            color: #e0e0e0;
        }

        body.dark .event-log .event.buttondown {
            background: #1b5e20;
            border-color: #2e7d32;
            color: #c8e6c9;
        }

        body.dark .event-log .event.buttonup {
            background: #b71c1c;
            border-color: #d32f2f;
            color: #ffcdd2;
        }

        body.dark .event-log .event.buttonpress {
            background: #e65100;
            border-color: #ff9800;
            color: #ffe0b2;
        }

        body.dark .event-log .event.axischange {
            background: #1565c0;
            border-color: #1976d2;
            color: #bbdefb;
        }

        body.dark .event-log .event.grab {
            background: #4a148c;
            border-color: #7b1fa2;
            color: #e1bee7;
        }

        body.dark .event-log .event.drop {
            background: #bf360c;
            border-color: #d84315;
            color: #ffccbc;
        }

        body.dark .event-log .event.connect {
            background: #1b5e20;
            border-color: #2e7d32;
            color: #c8e6c9;
        }

        body.dark .event-log .event.disconnect {
            background: #b71c1c;
            border-color: #d32f2f;
            color: #ffcdd2;
        }

        body.dark .event-log .event.error {
            background: #b71c1c;
            border-color: #d32f2f;
            color: #ffcdd2;
        }

        @media (max-width: 768px) {
            .analog-container {
                grid-template-columns: 1fr;
            }
            
            .button-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }
            
            .install-prompt {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .theme-toggle {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gamepad Test Suite v3.0.0</h1>
            <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">🌙</button>
        </div>
        
        <div id="status" class="status disconnected">
            No controllers connected. Connect a gamepad and press any button.
        </div>
        
        <!-- PWA Install Prompt -->
        <div id="install-prompt" class="install-prompt" style="display: none;">
            <div class="install-content">
                <h3>Install Gamepad Test Suite</h3>
                <p>Install this app for a better experience and offline access.</p>
                <button id="install-btn" class="install-btn">Install</button>
                <button id="dismiss-install" class="dismiss-btn">Not now</button>
            </div>
        </div>

        <div class="grid">
            <div class="section">
                <h2>Controller Information</h2>
                <div class="controller-selector">
                    <label for="controller-select">Controller:</label>
                    <select id="controller-select">
                        <option value="">No controllers</option>
                    </select>
                </div>
                <div id="controller-info" class="controller-info">
                    <p>No controller connected</p>
                </div>
                
                <div class="dead-zone-controls">
                <div class="dead-zone-control">
                        <label for="left-deadzone">Left Dead Zone:</label>
                        <input type="range" id="left-deadzone" min="0" max="0.5" step="0.01" value="0.0">
                        <span id="left-deadzone-value">0.00</span>
                    </div>
                    <div class="dead-zone-control">
                        <label for="right-deadzone">Right Dead Zone:</label>
                        <input type="range" id="right-deadzone" min="0" max="0.5" step="0.01" value="0.0">
                        <span id="right-deadzone-value">0.00</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Buttons</h2>
                <div class="button-grid" id="buttons-grid"></div>
            </div>

            <div class="section">
                <h2>Analog Sticks</h2>
                <div class="analog-container">
                    <div class="analog-section">
                        <h3>Left Stick</h3>
                        <div class="analog-stick" id="left-stick">
                            <div class="analog-indicator" id="left-indicator"></div>
                        </div>
                        <div class="analog-info" id="left-info">
                            X: 0.00 | Y: 0.00<br>
                            Mag: 0.00 | Ang: 0°
                        </div>
                    </div>
                    <div class="analog-section">
                        <h3>Right Stick</h3>
                        <div class="analog-stick" id="right-stick">
                            <div class="analog-indicator" id="right-indicator"></div>
                        </div>
                        <div class="analog-info" id="right-info">
                            X: 0.00 | Y: 0.00<br>
                            Mag: 0.00 | Ang: 0°
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Vibration Effects</h2>
                <div class="vibration-controls">
                    <button class="vibration-btn" onclick="testVibrationPreset('light-tap')">Light Tap</button>
                    <button class="vibration-btn" onclick="testVibrationPreset('medium-rumble')">Medium</button>
                    <button class="vibration-btn" onclick="testVibrationPreset('heavy-shake')">Heavy</button>
                    <button class="vibration-btn" onclick="testVibrationPreset('notification')">Notification</button>
                    <button class="vibration-btn" onclick="testVibrationPreset('damage')">Damage</button>
                    <button class="vibration-btn" onclick="testCustomVibration()">Custom</button>
                    <button class="vibration-btn" onclick="testVibrationSequence()">Sequence</button>
                    <button class="vibration-btn stop" onclick="stopVibration()">Stop</button>
                </div>
            </div>

            <div class="section" style="grid-column: 1 / -1;">
                <h2>Custom Vibration Pattern Designer</h2>
                <div class="pattern-designer">
                    <div class="pattern-controls">
                        <button id="add-pattern" class="pattern-btn">Add Pattern</button>
                        <button id="test-pattern" class="pattern-btn">Test Pattern</button>
                        <button id="stop-pattern" class="pattern-btn stop">Stop</button>
                        <button id="export-code" class="pattern-btn">Export Code</button>
                        <button id="clear-patterns" class="pattern-btn">Clear All</button>
                    </div>
                    
                    <div id="pattern-list" class="pattern-list">
                        <div class="pattern-placeholder">
                            <p>No patterns yet. Click "Add Pattern" to create your first vibration pattern.</p>
                        </div>
                    </div>
                    
                    <div id="code-output" class="code-output" style="display: none;">
                        <h3>Generated TypeScript Code</h3>
                        <pre id="code-content"></pre>
                        <button id="copy-code" class="pattern-btn">Copy to Clipboard</button>
                    </div>
                </div>
            </div>

            <div class="section" style="grid-column: 1 / -1;">
                <h2>Event Log</h2>
                <button class="clear-log" onclick="clearEventLog()">Clear Log</button>
                <div id="event-log" class="event-log">
                    <div class="event">Waiting for events...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('install-prompt');
        const installBtn = document.getElementById('install-btn');
        const dismissBtn = document.getElementById('dismiss-install');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show the install prompt
            installPrompt.style.display = 'block';
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                // Clear the deferredPrompt
                deferredPrompt = null;
                // Hide the install prompt
                installPrompt.style.display = 'none';
            }
        });

        dismissBtn.addEventListener('click', () => {
            installPrompt.style.display = 'none';
        });

        // Handle app installed
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA was installed');
            installPrompt.style.display = 'none';
        });

        // Handle service worker updates
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                // New service worker is controlling the page
                console.log('Service worker updated');
                showUpdateNotification();
            });
        }

        function showUpdateNotification() {
            const updateNotification = document.createElement('div');
            updateNotification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                background: #4caf50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1001;
                font-size: 0.9em;
                max-width: 300px;
            `;
            updateNotification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>✅ App updated successfully!</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2em; margin-left: 10px;">×</button>
                </div>
            `;
            document.body.appendChild(updateNotification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (updateNotification.parentElement) {
                    updateNotification.remove();
                }
            }, 5000);
        }

        // Theme Management
        let isDarkMode = false;

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            
            if (isDarkMode) {
                body.classList.add('dark');
                themeToggle.classList.add('dark');
                themeToggle.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark');
                themeToggle.classList.remove('dark');
                themeToggle.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme on page load
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                isDarkMode = true;
                document.body.classList.add('dark');
                document.getElementById('theme-toggle').classList.add('dark');
                document.getElementById('theme-toggle').textContent = '☀️';
            }
        }
    </script>

    <script type="module">
        import { GamepadManager, Controller } from './dist/esm/gamepad.js';

        let currentController = null;
        let eventLog = [];
        let controllers = new Map();
        
        // Vibration Pattern Designer
        let vibrationPatterns = [];
        let patternIdCounter = 0;

        // Initialize button grid
        function initializeButtons() {
            const buttonsGrid = document.getElementById('buttons-grid');
            const buttonNames = Object.keys(Controller.BUTTONS_MAP);
            
            buttonNames.forEach(buttonName => {
                const button = document.createElement('div');
                button.className = 'button';
                button.id = `btn-${buttonName}`;
                
                // Show both Xbox and PlayStation names for main buttons
                let displayName = buttonName;
                if (buttonName === 'A') displayName = 'A (X)';
                else if (buttonName === 'B') displayName = 'B (O)';
                else if (buttonName === 'X') displayName = 'X (□)';
                else if (buttonName === 'Y') displayName = 'Y (△)';
                
                button.innerHTML = `
                    <div>${displayName}</div>
                    <div class="button-value" id="value-${buttonName}">0.00</div>
                `;
                buttonsGrid.appendChild(button);
            });
        }

        // Update button display
        function updateButton(buttonName, pressed, value) {
            const button = document.getElementById(`btn-${buttonName}`);
            const valueDisplay = document.getElementById(`value-${buttonName}`);
            
            if (button) {
                button.classList.toggle('pressed', pressed);
            }
            
            if (valueDisplay) {
                // For triggers (LT, RT), show the actual value (0-1 range)
                // For other buttons, show 1.00 if pressed, 0.00 if not
                if (buttonName === 'LT' || buttonName === 'RT') {
                valueDisplay.textContent = value.toFixed(2);
                } else {
                    valueDisplay.textContent = pressed ? '1.00' : '0.00';
                }
            }
        }

        // Update analog stick display with proper circular clamping
        function updateAnalogStick(side, position) {
            const stick = document.getElementById(`${side}-stick`);
            const indicator = document.getElementById(`${side}-indicator`);
            const info = document.getElementById(`${side}-info`);
            
            if (stick && indicator && info) {
                // Convert from -1,1 to 0,100 for positioning (already clamped by library)
                const x = ((position.x + 1) / 2) * 100;
                const y = ((position.y + 1) / 2) * 100;
                
                indicator.style.left = `${x}%`;
                indicator.style.top = `${y}%`;
                
                info.innerHTML = `
                    X: ${position.x.toFixed(2)} | Y: ${position.y.toFixed(2)}<br>
                    Mag: ${position.magnitude.toFixed(2)} | Ang: ${(position.angle * 180 / Math.PI).toFixed(0)}°
                `;
            }
        }

        // Log events with filtering to reduce spam
        function logEvent(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const event = { type, args, timestamp };
            
            // Filter out spammy axis events
            if (type === 'axischange' && eventLog.length > 0) {
                const lastEvent = eventLog[0];
                if (lastEvent.type === 'axischange' && 
                    lastEvent.args[0] === args[0] && 
                    Math.abs(parseFloat(lastEvent.args[1]) - parseFloat(args[1])) < 0.01) {
                    return; // Skip similar axis events
                }
            }
            
            eventLog.unshift(event);
            if (eventLog.length > 50) {
                eventLog.pop();
            }
            
            updateEventLogDisplay();
        }

        // Update event log display
        function updateEventLogDisplay() {
            const logContainer = document.getElementById('event-log');
            logContainer.innerHTML = eventLog.map(event => {
                const argsStr = event.args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                ).join(', ');
                
                return `<div class="event ${event.type}">[${event.timestamp}] ${event.type}: ${argsStr}</div>`;
            }).join('');
        }

        // Clear event log
        window.clearEventLog = function() {
            eventLog = [];
            updateEventLogDisplay();
        };

        // Update controller selector
        function updateControllerSelector() {
            const selector = document.getElementById('controller-select');
            selector.innerHTML = '<option value="">No controllers</option>';
            
            controllers.forEach((controller, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Controller ${index} (${controller.getType()})`;
                selector.appendChild(option);
            });
            
            if (currentController) {
                selector.value = currentController.index;
            }
        }

        // Update controller info
        function updateControllerInfo(controller) {
            const info = document.getElementById('controller-info');
            if (controller) {
                const pressed = controller.getPressed();
                info.innerHTML = `
                    <p><strong>Index:</strong> ${controller.index}</p>
                    <p><strong>Type:</strong> ${controller.getType()}</p>
                    <p><strong>Left Dead Zone:</strong> ${controller.getLeftAnalogDeadZone().toFixed(2)}</p>
                    <p><strong>Right Dead Zone:</strong> ${controller.getRightAnalogDeadZone().toFixed(2)}</p>
                    <p><strong>Left Analog:</strong> ${controller.isLeftAnalogHeld() ? 'Held' : 'Released'}</p>
                    <p><strong>Right Analog:</strong> ${controller.isRightAnalogHeld() ? 'Held' : 'Released'}</p>
                    <p><strong>Pressed:</strong> ${pressed.length > 0 ? pressed.join(', ') : 'None'}</p>
                `;
            } else {
                info.innerHTML = '<p>No controller connected</p>';
            }
        }

        // Setup event listeners for a controller
        function setupControllerEvents(controller) {
            controller.addEventListener('buttondown', (buttonName, value) => {
                let displayName = buttonName;
                if (buttonName === 'A') displayName = 'A (X)';
                else if (buttonName === 'B') displayName = 'B (O)';
                else if (buttonName === 'X') displayName = 'X (□)';
                else if (buttonName === 'Y') displayName = 'Y (△)';
                logEvent('buttondown', displayName, value.toFixed(2));
                
                // Update button display immediately
                updateButton(buttonName, true, value);
                updateControllerInfo(); // Update pressed buttons list
            });

            controller.addEventListener('buttonup', (buttonName, value) => {
                let displayName = buttonName;
                if (buttonName === 'A') displayName = 'A (X)';
                else if (buttonName === 'B') displayName = 'B (O)';
                else if (buttonName === 'X') displayName = 'X (□)';
                else if (buttonName === 'Y') displayName = 'Y (△)';
                logEvent('buttonup', displayName, value.toFixed(2));
                
                // Update button display immediately
                updateButton(buttonName, false, value);
                updateControllerInfo(); // Update pressed buttons list
            });

            controller.addEventListener('axischange', (axisName, value, angle, repeat) => {
                if (!repeat) { // Only log non-repeat events to reduce spam
                    logEvent('axischange', axisName, value.toFixed(2));
                }
                
                // Update analog display immediately
                updateAnalogFromAxis(axisName, value);
                updateControllerInfo(); // Update analog held state
            });

            // Handle trigger changes specifically
            controller.addEventListener('buttonpress', (buttonName, value, wasPressed) => {
                // Update trigger displays immediately
                if (buttonName === 'LT' || buttonName === 'RT') {
                    updateButton(buttonName, value > 0.1, value);
                    updateControllerInfo(); // Update pressed buttons list
                }
            });


            controller.addEventListener('grab', (analogName) => {
                logEvent('grab', analogName);
                updateControllerInfo(); // Update analog held state display
            });

            controller.addEventListener('drop', (analogName) => {
                logEvent('drop', analogName);
                updateControllerInfo(); // Update analog held state display
            });
        }

        // Update analog stick from individual axis changes
        function updateAnalogFromAxis(axisName, value) {
            if (!currentController) return;
            
            const state = currentController.getState();
            let leftStick = { ...state.analogs.leftStick };
            let rightStick = { ...state.analogs.rightStick };
            
            if (axisName === 'LEFT_X') {
                leftStick.x = value;
                leftStick.magnitude = Math.sqrt(leftStick.x * leftStick.x + leftStick.y * leftStick.y);
                leftStick.angle = Math.atan2(leftStick.y, leftStick.x);
                updateAnalogStick('left', leftStick);
            } else if (axisName === 'LEFT_Y') {
                leftStick.y = value;
                leftStick.magnitude = Math.sqrt(leftStick.x * leftStick.x + leftStick.y * leftStick.y);
                leftStick.angle = Math.atan2(leftStick.y, leftStick.x);
                updateAnalogStick('left', leftStick);
            } else if (axisName === 'RIGHT_X') {
                rightStick.x = value;
                rightStick.magnitude = Math.sqrt(rightStick.x * rightStick.x + rightStick.y * rightStick.y);
                rightStick.angle = Math.atan2(rightStick.y, rightStick.x);
                updateAnalogStick('right', rightStick);
            } else if (axisName === 'RIGHT_Y') {
                rightStick.y = value;
                rightStick.magnitude = Math.sqrt(rightStick.x * rightStick.x + rightStick.y * rightStick.y);
                rightStick.angle = Math.atan2(rightStick.y, rightStick.x);
                updateAnalogStick('right', rightStick);
            }
        }

        // Modern reactive display updates (now only used for initial setup)
        function updateDisplays() {
            try {
                if (currentController) {
                    // Get reactive state (cached for performance)
                    const state = currentController.getState();
                    
                    // Update UI reactively
                    updateButtons(state.buttons);
                    updateAnalogs(state.analogs);
                    updateControllerInfo(currentController);
                }
            } catch (error) {
                console.error('Error in updateDisplays:', error);
            }
        }

        // Modern reactive button updates
        function updateButtons(buttons) {
            Object.entries(buttons).forEach(([buttonName, buttonState]) => {
                updateButton(buttonName, buttonState.pressed, buttonState.value);
            });
        }

        // Modern reactive analog updates
        function updateAnalogs(analogs) {
            updateAnalogStick('left', analogs.leftStick);
            updateAnalogStick('right', analogs.rightStick);
        }

        // Dead zone controls
        document.getElementById('left-deadzone').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('left-deadzone-value').textContent = value.toFixed(2);
            
            if (currentController) {
                currentController.setLeftAnalogDeadZone(value);
            }
        });

        document.getElementById('right-deadzone').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('right-deadzone-value').textContent = value.toFixed(2);
            
            if (currentController) {
                currentController.setRightAnalogDeadZone(value);
            }
        });

        // Controller selector
        document.getElementById('controller-select').addEventListener('change', (e) => {
            const selectedIndex = parseInt(e.target.value);
            if (!isNaN(selectedIndex)) {
                currentController = controllers.get(selectedIndex);
                updateControllerInfo(currentController);
            } else {
                currentController = null;
                updateControllerInfo(null);
            }
        });

        // Vibration test functions
        window.testVibrationPreset = async function(preset) {
            if (currentController) {
                try {
                    logEvent('vibration', `Preset: ${preset}`);
                    await currentController.vibratePreset(preset);
                } catch (error) {
                    logEvent('error', error.message);
                }
            }
        };

        window.testCustomVibration = async function() {
            if (currentController) {
                try {
                    logEvent('vibration', 'Custom 500ms');
                    await currentController.vibrate('dual-rumble', 0, 500, 0.8, 1.0);
                } catch (error) {
                    logEvent('error', error.message);
                }
            }
        };

        window.testVibrationSequence = async function() {
            if (currentController) {
                try {
                    logEvent('vibration', 'Sequence');
                    await currentController.vibratePattern([
                        { delay: 0, duration: 100, weak: 0.3, strong: 0.3 },
                        { delay: 150, duration: 150, weak: 0.6, strong: 0.6 },
                        { delay: 200, duration: 200, weak: 1.0, strong: 1.0 }
                    ]);
                } catch (error) {
                    logEvent('error', error.message);
                }
            }
        };

        window.stopVibration = function() {
            if (currentController) {
                currentController.stopVibration();
                logEvent('vibration', 'Stopped');
            }
        };

        // GamepadManager event listeners
        GamepadManager.on('connect', (controller) => {
            controllers.set(controller.index, controller);
            
            // Set as current if it's the first one
            if (!currentController) {
            currentController = controller;
            }
            
            document.getElementById('status').textContent = `${controllers.size} controller(s) connected`;
            document.getElementById('status').className = 'status connected';
            
            logEvent('connect', `Index ${controller.index}`, controller.getType());
            setupControllerEvents(controller);
            updateControllerSelector();
            updateControllerInfo(currentController);
        });

        GamepadManager.on('disconnect', (controller) => {
            logEvent('disconnect', `Index ${controller.index}`);
            controllers.delete(controller.index);
            
            // Switch to another controller if current one disconnected
            if (currentController === controller) {
                const firstController = controllers.values().next().value;
                currentController = firstController || null;
            }
            
            if (controllers.size === 0) {
                document.getElementById('status').textContent = 'No controllers connected. Connect a gamepad and press any button.';
            document.getElementById('status').className = 'status disconnected';
                currentController = null;
            } else {
                document.getElementById('status').textContent = `${controllers.size} controller(s) connected`;
            }
            
            updateControllerSelector();
            updateControllerInfo(currentController);
        });

        // Initialize
        loadTheme();
        initializeButtons();
        updateControllerInfo(null);

        // Check for already connected controllers
        const existingControllers = GamepadManager.getControllers();
        existingControllers.forEach(controller => {
            controllers.set(controller.index, controller);
            setupControllerEvents(controller);
        });
        
        if (existingControllers.length > 0) {
            currentController = existingControllers[0];
            document.getElementById('status').textContent = `${controllers.size} controller(s) connected`;
            document.getElementById('status').className = 'status connected';
        }
        
        updateControllerSelector();
            updateControllerInfo(currentController);

        // Initial display update (no more polling - everything is event-driven now)
        updateDisplays();

        // Vibration Pattern Designer Functions
        function initializePatternDesigner() {
            const addPatternBtn = document.getElementById('add-pattern');
            const testPatternBtn = document.getElementById('test-pattern');
            const stopPatternBtn = document.getElementById('stop-pattern');
            const exportCodeBtn = document.getElementById('export-code');
            const clearPatternsBtn = document.getElementById('clear-patterns');
            const copyCodeBtn = document.getElementById('copy-code');

            addPatternBtn.addEventListener('click', addPattern);
            testPatternBtn.addEventListener('click', testPattern);
            stopPatternBtn.addEventListener('click', stopPattern);
            exportCodeBtn.addEventListener('click', exportCode);
            clearPatternsBtn.addEventListener('click', clearPatterns);
            copyCodeBtn.addEventListener('click', copyCodeToClipboard);

            updatePatternList();
        }

        function addPattern() {
            const pattern = {
                id: patternIdCounter++,
                delay: 0,
                duration: 100,
                weak: 0.5,
                strong: 0.5
            };
            vibrationPatterns.push(pattern);
            updatePatternList();
        }

        function removePattern(patternId) {
            vibrationPatterns = vibrationPatterns.filter(p => p.id !== patternId);
            updatePatternList();
        }

        function updatePatternList() {
            const patternList = document.getElementById('pattern-list');
            
            if (vibrationPatterns.length === 0) {
                patternList.innerHTML = '<div class="pattern-placeholder"><p>No patterns yet. Click "Add Pattern" to create your first vibration pattern.</p></div>';
                return;
            }

            patternList.innerHTML = vibrationPatterns.map((pattern, index) => `
                <div class="pattern-item" data-pattern-id="${pattern.id}">
                    <div class="pattern-header">
                        <div class="pattern-title">
                            Pattern ${index + 1}
                        </div>
                        <div class="pattern-actions">
                            <button class="pattern-action-btn remove" onclick="removePattern(${pattern.id})">×</button>
                        </div>
                    </div>
                    <div class="pattern-properties">
                        <div class="pattern-property">
                            <label>Delay (ms)</label>
                            <input type="number" value="${pattern.delay}" min="0" step="10" 
                                   onchange="updatePatternProperty(${pattern.id}, 'delay', this.value)">
                        </div>
                        <div class="pattern-property">
                            <label>Duration (ms)</label>
                            <input type="number" value="${pattern.duration}" min="1" step="10" 
                                   onchange="updatePatternProperty(${pattern.id}, 'duration', this.value)">
                        </div>
                        <div class="pattern-property">
                            <label>Weak Motor</label>
                            <input type="range" value="${pattern.weak}" min="0" max="1" step="0.1" 
                                   onchange="updatePatternProperty(${pattern.id}, 'weak', this.value)">
                        </div>
                        <div class="pattern-property">
                            <label>Strong Motor</label>
                            <input type="range" value="${pattern.strong}" min="0" max="1" step="0.1" 
                                   onchange="updatePatternProperty(${pattern.id}, 'strong', this.value)">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updatePatternProperty(patternId, property, value) {
            const pattern = vibrationPatterns.find(p => p.id === patternId);
            if (pattern) {
                pattern[property] = parseFloat(value);
                updatePatternList();
            }
        }


        async function testPattern() {
            if (!currentController) {
                logEvent('error', 'No controller connected');
                return;
            }

            if (vibrationPatterns.length === 0) {
                logEvent('error', 'No patterns to test');
                return;
            }

            try {
                logEvent('vibration', 'Testing custom pattern');
                // Convert patterns to the correct format for vibratePattern
                const patternSteps = vibrationPatterns.map(pattern => ({
                    delay: pattern.delay,
                    duration: pattern.duration,
                    weak: pattern.weak,
                    strong: pattern.strong
                }));
                await currentController.vibratePattern(patternSteps);
            } catch (error) {
                logEvent('error', error.message);
            }
        }

        function stopPattern() {
            if (currentController) {
                currentController.stopVibration();
                logEvent('vibration', 'Stopped');
            }
        }

        function exportCode() {
            if (vibrationPatterns.length === 0) {
                logEvent('error', 'No patterns to export');
                return;
            }

            const codeOutput = document.getElementById('code-output');
            const codeContent = document.getElementById('code-content');
            
            const code = generateTypeScriptCode();
            codeContent.textContent = code;
            codeOutput.style.display = 'block';
            
            // Scroll to code output
            codeOutput.scrollIntoView({ behavior: 'smooth' });
        }

        function generateTypeScriptCode() {
            const patternCode = vibrationPatterns.map(pattern => 
                `    { delay: ${pattern.delay}, duration: ${pattern.duration}, weak: ${pattern.weak}, strong: ${pattern.strong} }`
            ).join(',\n');

            return `// Generated vibration pattern
await controller.vibratePattern([
${patternCode}
]);`;
        }

        async function copyCodeToClipboard() {
            const codeContent = document.getElementById('code-content');
            const code = codeContent.textContent;
            
            try {
                await navigator.clipboard.writeText(code);
                logEvent('success', 'Code copied to clipboard');
                
                // Show temporary feedback
                const copyBtn = document.getElementById('copy-code');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.style.background = '#4caf50';
                copyBtn.style.color = 'white';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                    copyBtn.style.color = '';
                }, 2000);
            } catch (error) {
                logEvent('error', 'Failed to copy code');
            }
        }

        function clearPatterns() {
            if (vibrationPatterns.length === 0) {
                logEvent('info', 'No patterns to clear');
                return;
            }
            
            if (confirm('Are you sure you want to clear all patterns?')) {
                vibrationPatterns = [];
                patternIdCounter = 0;
                updatePatternList();
                document.getElementById('code-output').style.display = 'none';
                logEvent('info', 'All patterns cleared');
            }
        }

        // Make functions globally available
        window.removePattern = removePattern;
        window.updatePatternProperty = updatePatternProperty;

        // Initialize pattern designer
        initializePatternDesigner();
    </script>
</body>
</html>